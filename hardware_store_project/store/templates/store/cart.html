<!-- store/templates/store/cart.html -->
<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Корзина</title>
    <style>
        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .quantity-controls button {
            width: 30px;
        }
    </style>
</head>

<body data-client-id="{{ client_id }}">

    <h1>Ваша корзина</h1>

    {% if cart_items %}
    <table border="1" cellpadding="5">
        <thead>
            <tr>
                <th>Товар</th>
                <th>Количество</th>
                <th>Цена за шт.</th>
                <th>Итого</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody>
            {% for item in cart_items %}
            <tr data-product-id="{{ item.product.product_id }}">
                <td>{{ item.product.product_name }}</td>
                <td>
                    <div class="quantity-controls">
                        <button class="decrease-btn" data-product-id="{{ item.product.product_id }}">-</button>
                        <span class="quantity-display" id="qty-{{ item.product.product_id }}">{{ item.quantity }}</span>
                        <button class="increase-btn" data-product-id="{{ item.product.product_id }}"
                            data-max-qty="{{ item.available_quantity }}">+</button>
                    </div>
                </td>
                <td>{{ item.product.product_price_for_sale }} руб.</td>
                <td class="subtotal-display" id="subtotal-{{ item.product.product_id }}">{{ item.subtotal|floatformat:2
                    }} руб.</td>
                <td><button class="remove-btn" data-product-id="{{ item.product.product_id }}">Удалить</button></td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr>
                <td colspan="3" style="text-align: right;"><strong>Общая сумма:</strong></td>
                <td id="total-price"><strong>{{ total_price|floatformat:2 }} руб.</strong></td>
                <td></td>
            </tr>
        </tfoot>
    </table>

    <form method="post" id="checkout-form">
        {% csrf_token %}
        <button type="submit">Оформить заказ</button>
    </form>
    {% else %}
    <p>Корзина пуста.</p>
    {% endif %}

    <a href="{% url 'product_catalog' client_id=client_id %}">Назад в каталог</a>

    {% csrf_token %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const clientId = document.body.dataset.clientId;
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            // Функция для обновления общей суммы
            function updateTotal() {
                let total = 0;
                document.querySelectorAll('.subtotal-display').forEach(el => {
                    total += parseFloat(el.textContent);
                });
                document.getElementById('total-price').innerHTML = `<strong>${total.toFixed(2)} руб.</strong>`;
            }

            // Обработчик для кнопки "Уменьшить количество"
            document.addEventListener('click', function (e) {
                if (e.target.classList.contains('decrease-btn')) {
                    const productId = parseInt(e.target.dataset.productId);
                    const qtyEl = document.getElementById(`qty-${productId}`);
                    let qty = parseInt(qtyEl.textContent);
                    if (qty > 1) {
                        qty--;
                        qtyEl.textContent = qty;
                        updateSubtotal(productId); // Обновляем подитог для этого товара
                        updateTotal(); // Обновляем общую сумму
                        updateCart(productId, qty); // Отправляем обновление на сервер
                    }
                }
            });

            // Обработчик для кнопки "Увеличить количество"
            document.addEventListener('click', function (e) {
                if (e.target.classList.contains('increase-btn')) {
                    const productId = parseInt(e.target.dataset.productId);
                    const maxQty = parseInt(e.target.dataset.maxQty);
                    const qtyEl = document.getElementById(`qty-${productId}`);
                    let qty = parseInt(qtyEl.textContent);
                    if (qty < maxQty) {
                        qty++;
                        qtyEl.textContent = qty;
                        updateSubtotal(productId);
                        updateTotal();
                        updateCart(productId, qty);
                    }
                }
            });

            // Обработчик для кнопки "Удалить"
            document.addEventListener('click', function (e) {
                if (e.target.classList.contains('remove-btn')) {
                    const productId = parseInt(e.target.dataset.productId);
                    if (!confirm('Удалить товар из корзины?')) return;

                    fetch('{% url "remove_from_cart" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken,
                        },
                        body: JSON.stringify({
                            product_id: productId,
                            client_id: clientId,
                        }),
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                location.reload(); // Перезагружаем страницу после удаления
                            } else {
                                alert('Ошибка: ' + data.message);
                            }
                        })
                        .catch(err => {
                            console.error(err);
                            alert('Не удалось удалить товар');
                        });
                }
            });

            // Обработчик для формы оформления заказа
            const checkoutForm = document.getElementById('checkout-form');
            if (checkoutForm) {
                checkoutForm.addEventListener('submit', function (e) {
                    e.preventDefault();
                    fetch('{% url "checkout" client_id=client_id %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken,
                        },
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                alert('Заказ успешно оформлен!');
                                window.location.href = "{% url 'client_dashboard' client_id=client_id %}";
                            } else {
                                alert('Ошибка: ' + data.message);
                            }
                        })
                        .catch(err => {
                            console.error(err);
                            alert('Ошибка при отправке заказа');
                        });
                });
            }

            // Функция для обновления подитога для одного товара
            function updateSubtotal(productId) {
                const qtyEl = document.getElementById(`qty-${productId}`);
                const qty = parseInt(qtyEl.textContent);
                const priceEl = document.querySelector(`tr[data-product-id="${productId}"] td:nth-child(3)`); // Цена за шт.
                const price = parseFloat(priceEl.textContent.replace(' руб.', '').replace(',', '.')); // Убираем "руб." и заменяем запятую на точку
                const subtotal = qty * price;
                const subtotalEl = document.getElementById(`subtotal-${productId}`);
                subtotalEl.textContent = subtotal.toFixed(2) + ' руб.';
            }

            // Функция для отправки обновления количества на сервер
            function updateCart(productId, quantity) {
                fetch('{% url "update_cart_item" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                    },
                    body: JSON.stringify({
                        product_id: productId,
                        quantity: quantity,
                        client_id: clientId,
                    }),
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status !== 'success') {
                            alert('Ошибка: ' + data.message);
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        alert('Не удалось обновить корзину');
                    });
            }

            // Инициализация: обновляем все подитоги и общую сумму при загрузке страницы
            document.querySelectorAll('.quantity-display').forEach(el => {
                const productId = parseInt(el.id.split('-')[1]);
                updateSubtotal(productId);
            });
            updateTotal();
        });
    </script>

</body>

</html>