<!-- templates/store/manager_client_orders.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Заказы клиента {{ client.client_fio }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>Заказы клиента: {{ client.client_fio }}</h2>
            <a href="{% url 'logout' %}" class="btn btn-secondary">Выйти</a>
        </div>
        <p><strong>Телефон:</strong> {{ client.client_phone|default:"Не указан" }}</p>
        <p><strong>Ваш менеджер:</strong> {{ manager.employee_name }} ({{ manager.employee_phone|default:"нет телефона" }})</p>

        <h4 class="mt-4">Список заказов:</h4>
        {% if orders_data %}
            <div class="table-responsive">
                <table class="table table-bordered table-striped">
                    <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Дата</th>
                            <th>Статус заказа</th>
                            <th>Канал</th>
                            <th>Сумма</th>
                            <th>Скидка</th>
                            <th>Отзыв</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in orders_data %}
                        <tr>
                            <td>{{ order.order_id }}</td>
                            <td>{{ order.order_time|date:"d.m.Y H:i" }}</td>
                            <td>
                                <select class="form-select form-select-sm status-select" data-order-id="{{ order.order_id }}">
                                    <option value="new" {% if order.order_status == 'new' %}selected{% endif %}>Новый</option>
                                    <option value="in_progress" {% if order.order_status == 'in_progress' %}selected{% endif %}>В работе</option>
                                    <option value="shipped" {% if order.order_status == 'shipped' %}selected{% endif %}>Отправлен</option>
                                    <option value="delivered" {% if order.order_status == 'delivered' %}selected{% endif %}>Доставлен</option>
                                </select>
                            </td>
                            <td>{{ order.order_channel }}</td>
                            <td>{{ order.total_amount }} ₽</td>
                            <td>
                                <select class="form-select form-select-sm discount-select" data-order-id="{{ order.order_id }}">
                                    <option value="">Без скидки</option>
                                    {% for discount in discounts %}
                                    <option value="{{ discount.discount_id }}" {% if order.discount_id == discount.discount_id %}selected{% endif %}>{{ discount.discount_name }} ({{ discount.discount_percent }}%)</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>{{ order.client_feedback|default:"—" }}</td>
                            <td>
                                <button class="btn btn-sm btn-warning refund-btn" data-order-id="{{ order.order_id }}">Оформить возврат</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="alert alert-info">
                У клиента пока нет заказов.
            </div>
        {% endif %}

        <a href="{% url 'manager_dashboard' manager.employee_id %}" class="btn btn-secondary mt-3">
            ← Назад к списку клиентов
        </a>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            $('.status-select').change(function() {
                const orderId = $(this).data('order-id');
                const newStatus = $(this).val();

                if (!confirm(`Изменить статус заказа #${orderId} на "${newStatus}"?`)) {
                    return;
                }

                $.ajax({
                    url: '{% url "manager_update_order_status" %}',
                    type: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    },
                    data: JSON.stringify({
                        order_id: orderId,
                        new_status: newStatus
                    }),
                    success: function(response) {
                        if (response.status === 'success') {
                            alert(`Статус заказа #${orderId} успешно обновлён!`);
                        } else {
                            alert('Ошибка: ' + (response.message || 'неизвестная'));
                        }
                    },
                    error: function(xhr, status, error) {
                        alert('Ошибка при обновлении статуса: ' + error);
                    }
                });
            });

            $('.refund-btn').click(function() {
                const orderId = $(this).data('order-id');
                if (confirm(`Оформить возврат по заказу #${orderId}? Товары вернутся на склад.`)) {
                    $.ajax({
                        url: '{% url "manager_process_refund" %}',
                        type: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                            'Content-Type': 'application/json'
                        },
                        data: JSON.stringify({
                            order_id: orderId
                        }),
                        success: function(response) {
                            if (response.status === 'success') {
                                alert(response.message || 'Возврат успешно оформлен!');
                                location.reload();
                            } else {
                                alert('Ошибка: ' + (response.message || 'неизвестная'));
                            }
                        },
                        error: function(xhr, status, error) {
                            alert('Ошибка при оформлении возврата: ' + error);
                        }
                    });
                }
            });

            $('.discount-select').change(function() {
                const orderId = $(this).data('order-id');
                const discountId = $(this).val() || null;
                
                $.ajax({
                    url: '{% url "manager_update_discount" %}',
                    type: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    },
                    data: JSON.stringify({
                        order_id: orderId,
                        discount_id: discountId
                    }),
                    success: function(response) {
                        if (response.status === 'success') {
                            location.reload();
                        } else {
                            alert('Ошибка: ' + (response.message || 'неизвестная'));
                        }
                    },
                    error: function(xhr, status, error) {
                        alert('Ошибка при обновлении скидки: ' + error);
                    }
                });
            });
        });
    </script>
</body>
</html>

